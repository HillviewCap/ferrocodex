# Dockerfile for testing GUI applications
FROM ubuntu:22.04

# Install required packages
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    xvfb \
    libgtk-3-0 \
    libwebkit2gtk-4.0-37 \
    libayatana-appindicator3-1 \
    librsvg2-dev \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - && \
    apt-get install -y nodejs

# Install Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"

# Set working directory
WORKDIR /app

# Copy package files
COPY package*.json ./
COPY turbo.json ./
COPY apps/desktop/package*.json ./apps/desktop/

# Install dependencies
RUN npm install

# Copy source code
COPY . .

# Create script to run with virtual display
RUN echo '#!/bin/bash\nxvfb-run -a --server-args="-screen 0 1024x768x24" npm run tauri:dev' > /app/run-app.sh && \
    chmod +x /app/run-app.sh

# Expose port
EXPOSE 1420

CMD ["./run-app.sh"]